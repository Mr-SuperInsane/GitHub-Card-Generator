<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitHubリポジトリカード生成ツール – Fast UX</title>
  <style>
    :root {
      --bg:#f7f7f8; --fg:#1f2328; --muted:#66707b; --primary:#28a745; --primary-hover:#218838; --border:#e1e4e8; --danger:#d73a49; --card:#fff;
    }
    * { box-sizing: border-box }
    body{ font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; line-height:1.6; color:var(--fg); background:var(--bg); margin:0; }
    .wrap{ max-width:900px; margin:24px auto; padding:0 16px; }
    h1{ text-align:center; margin:0 0 16px; color:#24292e }
    .container{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,.05) }
    .row{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center }
    input[type="url"], input[type="text"], input[type="password"], textarea{ width:100%; padding:12px; font-size:16px; border:1px solid #c9ccd1; border-radius:8px; background:#fff }
    textarea{ height:190px; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace }
    button{ cursor:pointer; border:0; border-radius:8px; padding:12px 14px; font-size:15px; background:var(--primary); color:#fff }
    button:hover{ background:var(--primary-hover)}
    .ghost{ background:#eff1f3; color:#111; border:1px solid #d0d7de }
    .ghost:hover{ background:#e6eaef }
    .hint{ color:var(--muted); font-size:14px }
    .grid{ display:grid; gap:14px }
    .cols{ display:grid; gap:12px; grid-template-columns: 1fr 1fr }
    .section-title{ margin:10px 0 6px; font-weight:600 }
    .preview{ border:1px dashed #c9ccd1; border-radius:8px; padding:14px; min-height:90px; background:#fff }
    .toast{ position:fixed; inset:auto auto 16px 50%; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px; border-radius:999px; opacity:0; transition:opacity .25s, transform .25s; pointer-events:none }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px) }
    .err{ color:var(--danger) }
    .flex{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .kbd{ font-family:ui-monospace,monospace; border:1px solid #c9ccd1; padding:2px 6px; border-radius:6px; background:#fff }
    .hr{ height:1px; background:#ebeef1; margin:10px 0 }

    /* Card CSS that will be embedded into the generated snippet */
    .gh-card-container{ font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; border:1px solid #e1e4e8; border-radius:6px; padding:16px; margin:1.5em 0; line-height:1.4; background:#fff; max-width:600px }
    .gh-card-container a{ text-decoration:none; color:inherit }
    .gh-card-header{ display:flex; align-items:center; gap:8px; margin-bottom:8px }
    .gh-card-repo-name{ font-weight:600; font-size:1.1em; color:#0366d6 }
    .gh-card-repo-name:hover{ text-decoration:underline }
    .gh-card-description{ color:#586069; font-size:.9em; margin-bottom:16px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height:2.5em }
    .gh-card-footer{ display:flex; align-items:center; gap:16px; font-size:.8em; color:#586069 }
    .gh-card-language-color{ width:12px; height:12px; border-radius:50%; border:1px solid #d1d5da; margin-right:4px; display:inline-block; vertical-align:middle }
    .gh-card-owner{ margin-left:auto; display:flex; align-items:center; gap:6px }
    .gh-card-owner img{ width:24px; height:24px; border-radius:50% }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>GitHubリポジトリカード生成（高速版）</h1>
    <div class="container grid">
      <div class="row">
        <input type="text" id="repo-input" placeholder="https://github.com/username/repo または username/repo" autocomplete="off" />
        <div class="flex">
          <button id="generate-btn" title="Enterでも実行可">カード生成 ⏎</button>
          <button id="paste-btn" class="ghost" title="クリックでクリップボードからURLを取得">📋 クリップボード</button>
        </div>
      </div>
      <div class="hint">高速版の使い方：<span class="kbd">Enter</span>で生成／どこでも<span class="kbd">貼り付け</span>で自動検出／URLをドラッグ＆ドロップ／生成後は自動コピー</div>

      <div class="cols">
        <div>
          <div class="section-title">プレビュー</div>
          <div id="preview" class="preview">ここにプレビューが表示されます</div>
        </div>
        <div>
          <div class="section-title">WordPress用HTML</div>
          <textarea id="html-code" readonly placeholder="ここにHTMLコードが出力されます"></textarea>
          <div class="flex" style="margin-top:8px">
            <button id="copy-btn">HTMLをコピー</button>
            <button id="reset-btn" class="ghost">リセット</button>
          </div>
          <div class="hint">GitHub APIの制限回避のため、必要に応じてトークンを保存できます（任意）</div>
          <details>
            <summary>GitHubトークン（任意）</summary>
            <input type="password" id="token" placeholder="ghp_...（ローカル保存）" />
            <div class="flex">
              <button id="save-token" class="ghost">保存</button>
              <button id="clear-token" class="ghost">削除</button>
            </div>
          </details>
        </div>
      </div>

      <div class="hr"></div>
      <div class="hint">URLパラメータ <span class="kbd">?url=</span> または <span class="kbd">?repo=</span> で自動生成します。ブックマークレットも用意：<code>javascript:window.open('YOUR_TOOL_URL?url='+encodeURIComponent(location.href),'_blank')</code></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">コピーしました</div>

  <script>
    const $ = (s, r=document) => r.querySelector(s);
    const repoInput = $('#repo-input');
    const preview = $('#preview');
    const codeOutput = $('#html-code');
    const generateBtn = $('#generate-btn');
    const pasteBtn = $('#paste-btn');
    const copyBtn = $('#copy-btn');
    const resetBtn = $('#reset-btn');
    const toast = $('#toast');
    const tokenEl = $('#token');

    // --- UX: URLパラメータで自動生成（操作削減） ---
    (function initFromParams(){
      const params = new URL(location.href).searchParams;
      const urlParam = params.get('url') || params.get('repo');
      if(urlParam){
        repoInput.value = urlParam;
        generateCard();
      }
    })();

    // --- UX: どこでも貼り付けで自動入力＆実行 ---
    document.addEventListener('paste', (e)=>{
      const t = (e.clipboardData || window.clipboardData).getData('text');
      if(isLikelyRepo(t)){
        repoInput.value = t.trim();
        generateCard();
      }
    });

    // --- UX: ドラッグ＆ドロップ対応 ---
    document.addEventListener('dragover', e=>{ e.preventDefault(); });
    document.addEventListener('drop', e=>{
      e.preventDefault();
      const t = e.dataTransfer.getData('text');
      if(isLikelyRepo(t)){
        repoInput.value = t.trim();
        generateCard();
      }
    });

    // --- UX: Enterで実行 ---
    repoInput.addEventListener('keydown', e=>{
      if(e.key === 'Enter') { e.preventDefault(); generateCard(); }
    });

    // --- UX: 1クリックでクリップボードからURL取得 ---
    pasteBtn.addEventListener('click', async ()=>{
      try{
        const t = await navigator.clipboard.readText();
        if(!t){ return toastMsg('クリップボードが空です'); }
        repoInput.value = t.trim();
        generateCard();
      }catch(err){ toastMsg('クリップボードにアクセスできません'); }
    });

    // --- 保存されたトークン ---
    tokenEl.value = localStorage.getItem('gh_token') || '';
    $('#save-token').addEventListener('click', ()=>{ localStorage.setItem('gh_token', tokenEl.value.trim()); toastMsg('トークンを保存しました'); });
    $('#clear-token').addEventListener('click', ()=>{ localStorage.removeItem('gh_token'); tokenEl.value=''; toastMsg('トークンを削除しました'); });

    generateBtn.addEventListener('click', generateCard);
    copyBtn.addEventListener('click', ()=> tryCopy(codeOutput.value));
    resetBtn.addEventListener('click', ()=>{ repoInput.value=''; codeOutput.value=''; preview.textContent='ここにプレビューが表示されます'; });

    function isLikelyRepo(input){
      if(!input) return false;
      try{ new URL(input); }catch{ /* not a full URL */ }
      return /github\.com\/[^\/?#]+\/[\w.-]+/.test(input) || /^[-\w.]+\/[\w.-]+$/.test(input.trim());
    }

    function toRepoPath(raw){
      let s = raw.trim();
      try{ const u = new URL(s); if(u.hostname.includes('github.com')) s = u.pathname.replace(/^\//,''); }catch{ /* not URL */ }
      const [owner, repo] = s.split('/');
      if(!owner || !repo) throw new Error('リポジトリのパスが見つかりません (例: username/repo)');
      return `${owner}/${repo}`;
    }

    async function generateCard(){
      const raw = repoInput.value;
      preview.textContent = '読み込み中...';
      codeOutput.value = '';

      if(!isLikelyRepo(raw)){
        preview.innerHTML = '<span class="err">有効なGitHubのURL/パスを入力してください。</span>';
        return;
      }

      const repoPath = toRepoPath(raw);
      const apiUrl = `https://api.github.com/repos/${repoPath}`;
      const token = tokenEl.value.trim() || localStorage.getItem('gh_token') || '';

      try{
        const res = await fetch(apiUrl, { headers: token ? { 'Authorization': `Bearer ${token}` } : {} });
        if(!res.ok) throw new Error(`GitHub APIエラー: ${res.status}`);
        const data = await res.json();

        const cardHtml = buildCardHtml(data);
        preview.innerHTML = cardHtml;
        codeOutput.value = cardHtml.trim();

        // UX: 生成直後に自動コピー（ユーザー操作中のため許可されやすい）
        await tryCopy(codeOutput.value);
      }catch(err){
        preview.innerHTML = `<span class="err">エラー: ${err.message}</span>`;
      }
    }

    function buildCardHtml(data){
      const lang = data.language || '';
      const langColor = getLanguageColor(lang);
      return `\n<style>\n.gh-card-container{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif;border:1px solid #e1e4e8;border-radius:6px;padding:16px;margin:1.5em 0;line-height:1.4;background:#fff;max-width:600px}\n.gh-card-container a{text-decoration:none;color:inherit}\n.gh-card-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}\n.gh-card-repo-name{font-weight:600;font-size:1.1em;color:#0366d6}\n.gh-card-repo-name:hover{text-decoration:underline}\n.gh-card-description{color:#586069;font-size:.9em;margin-bottom:16px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.5em}\n.gh-card-footer{display:flex;align-items:center;gap:16px;font-size:.8em;color:#586069}\n.gh-card-language-color{width:12px;height:12px;border-radius:50%;border:1px solid #d1d5da;margin-right:4px;display:inline-block;vertical-align:middle}\n.gh-card-owner{margin-left:auto;display:flex;align-items:center;gap:6px}\n.gh-card-owner img{width:24px;height:24px;border-radius:50%}\n</style>\n<div class=\"gh-card-container\">\n  <a href=\"${data.html_url}\" target=\"_blank\" rel=\"noopener noreferrer\">\n    <div class=\"gh-card-header\">\n      <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" width=\"16\"><path d=\"M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 0 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Z M4.5 1h8V.75H4.5a1.75 1.75 0 0 0 0 3.5h8V3h-8a1.75 1.75 0 0 0 0-3.5Zm-2.25 8a.75.75 0 0 0 .75.75h4.5a.75.75 0 0 0 0-1.5h-4.5a.75.75 0 0 0-.75.75Z\"></path></svg>\n      <span class=\"gh-card-repo-name\">${escapeHtml(data.full_name)}</span>\n    </div>\n    <div class=\"gh-card-description\">${escapeHtml(data.description || 'No description provided.')}</div>\n    <div class=\"gh-card-footer\">\n      ${lang ? `<span><span class=\"gh-card-language-color\" style=\"background:${langColor}\"></span>${escapeHtml(lang)}</span>` : ''}\n      <span title=\"Stars\">⭐ ${data.stargazers_count}</span>\n      <span title=\"Forks\">⑂ ${data.forks_count}</span>\n      <span class=\"gh-card-owner\"><img src=\"${data.owner.avatar_url}\" alt=\"${escapeHtml(data.owner.login)}\">${escapeHtml(data.owner.login)}</span>\n    </div>\n  </a>\n</div>`;
    }

    function getLanguageColor(language){
      const colors={
        "JavaScript":"#f1e05a","TypeScript":"#3178c6","Python":"#3572A5","HTML":"#e34c26","CSS":"#563d7c","Java":"#b07219","Ruby":"#701516","PHP":"#4F5D95","C++":"#f34b7d","C#":"#178600","Go":"#00ADD8","Swift":"#ffac45","Kotlin":"#F18E33","Rust":"#dea584","Shell":"#89e051"
      }; return colors[language] || '#ededed';
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    async function tryCopy(text){
      if(!text) return false;
      try{ await navigator.clipboard.writeText(text); toastMsg('HTMLをコピーしました'); return true; }
      catch{ toastMsg('コピーに失敗。手動でコピーしてください'); return false; }
    }

    function toastMsg(msg){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(toast._t); toast._t = setTimeout(()=> toast.classList.remove('show'), 1600); }
  </script>
</body>
</html>
